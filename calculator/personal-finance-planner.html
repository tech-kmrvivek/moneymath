<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personal Finance Calculator | RupeesWise</title>
  <meta name="description" content="Plan your financial future with our comprehensive personal finance calculator. Track income, expenses, and savings to achieve your financial goals with confidence.">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/jpeg" href="/assets/images/fevicon.JPG">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    /* Custom styles for range sliders */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      background: #d1fae5; /* emerald-100 */
      border-radius: 5px;
      outline: none;
      opacity: 0.7;
      transition: opacity .2s;
    }
    input[type="range"]:hover {
      opacity: 1;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #10b981; /* emerald-500 */
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid white;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #10b981; /* emerald-500 */
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid white;
    }
    /* Style for the dynamic expense input fields */
    .expense-item {
        display: flex;
        flex-direction: column; /* Stack main row and words vertically */
        gap: 0.5rem; /* Smaller gap between rows */
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background-color: #f9fafb; /* gray-50 */
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .dark .expense-item {
        background-color: #374151; /* gray-700 */
    }
    .expense-item .expense-main-row { /* New wrapper for description, amount, button */
        display: flex;
        align-items: center;
        gap: 0.5rem; /* Gap between items in the row */
        flex-wrap: nowrap; /* Keep these three on one line */
        overflow-x: auto; /* Allow horizontal scroll for this row */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        width: 100%; /* Take full width of parent */
        padding-bottom: 0.25rem; /* Small padding at bottom before words */
    }

    .expense-item input, .expense-item select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db; /* gray-300 */
        border-radius: 0.375rem;
        background-color: #ffffff;
        color: #1f2937;
        flex-shrink: 1; /* Allow shrinking */
        min-width: 0; /* Allow content to shrink below intrinsic size */
    }
    .dark .expense-item input, .dark .expense-item select {
        border-color: #4b5563; /* gray-600 */
        background-color: #4b5563; /* gray-600 */
        color: #f9fafb;
    }

    .expense-item .expense-description {
        flex: 2 1 auto; /* Grow, shrink, initial auto size */
        min-width: 80px; /* Minimum width to prevent squishing too much */
    }
    .expense-item .flex.items-center { /* Amount input container */
        flex: 1 1 auto; /* Grow, shrink, initial auto size */
        min-width: 80px; /* Minimum width for amount input */
    }
    .expense-item .remove-expense-btn {
        flex: 0 0 auto; /* Fixed size, no grow/shrink */
        width: auto;
        padding: 0.5rem; /* Adjust padding to fit better */
    }
    .expense-item .expense-amount-words {
        text-align: right;
        margin-top: 0.25rem; /* Small margin from the input above */
        width: 100%; /* Ensure it takes full width for text alignment */
    }

    @media (min-width: 640px) { /* sm breakpoint */
        .expense-item {
            flex-direction: row; /* Revert to row for larger screens */
            display: grid; /* Use grid for larger screens as before */
            grid-template-columns: 1fr 0.8fr auto; /* Adjusted grid for 3 columns */
            gap: 1rem;
            overflow-x: visible; /* No scroll on larger screens */
        }
        .expense-item .expense-main-row {
            display: contents; /* Remove its own flex context, let grid handle positioning */
            padding-bottom: 0; /* Remove padding when in grid */
        }
        /* Adjust grid column spans for children */
        .expense-item .expense-description {
            grid-column: 1;
        }
        .expense-item .flex.items-center {
            grid-column: 2;
        }
        .expense-item .remove-expense-btn {
            grid-column: 3;
            justify-self: center;
            align-self: center;
        }
        .expense-item .expense-amount-words {
            grid-column: 2 / span 2; /* Span under amount and button on larger screens */
            text-align: right;
            margin-top: 0; /* Remove top margin when in grid */
        }
    }

    /* Styles for summary values */
    .summary-label {
        font-weight: 500; /* Medium weight */
        color: #4b5563; /* gray-700 - Matches input label color */
        font-size: 0.875rem; /* text-sm */
    }
    .dark .summary-label {
        color: #d1d5db; /* gray-300 - Matches input label color in dark mode */
    }
    .summary-value {
        font-weight: 600; /* Semi-bold */
        color: #059669; /* emerald-600 */
        font-size: 0.875rem; /* text-sm */
    }
    .dark .summary-value {
        color: #34d399; /* emerald-400 */
    }
    .summary-value.positive {
        color: #059669; /* emerald-600 */
    }
    .dark .summary-value.positive {
        color: #34d399; /* emerald-400 */
    }
    .summary-value.negative {
        color: #ef4444; /* red-600 */
    }
    .dark .summary-value.negative {
        color: #f87171; /* red-400 */
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">

  <!-- Placeholder for the Navigation Bar -->
  <div id="include-nav"></div>

  <!-- Main Content -->
  <main class="flex-1 w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Page Header -->
    <section class="text-center mb-10">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-emerald-600 dark:text-emerald-400 font-montserrat">Personal Finance Planner</h1>
        <p class="mt-3 text-lg text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
            Get a comprehensive overview of your financial future. Track your income, expenses, and savings to see if you're on track to meet your retirement goals.
        </p>
    </section>

    <div class="flex flex-col lg:flex-row gap-8">

      <!-- Left Side: Calculator Inputs -->
      <section class="w-full lg:w-1/3 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg space-y-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white font-montserrat">Enter Your Financial Details</h2>
        
        <!-- 1st Section: Ages & Timeline -->
        <div class="space-y-4 border-b border-gray-200 dark:border-gray-700 pb-6">
            <h3 class="text-md font-semibold text-gray-500 dark:text-gray-400">Your Timeline</h3>
            <div>
              <label for="currentAgeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Current Age</label>
              <input id="currentAgeInput" type="number" value="30" min="18" max="90" placeholder="e.g., 30" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              <input id="currentAgeSlider" type="range" min="18" max="90" value="30" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>18</span>
                <span>90</span>
              </div>
            </div>
            <div>
              <label for="retirementAgeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Retirement Age</label>
              <input id="retirementAgeInput" type="number" value="60" min="30" max="90" placeholder="e.g., 60" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              <input id="retirementAgeSlider" type="range" min="30" max="90" value="60" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>30</span>
                <span>90</span>
              </div>
            </div>
            <div>
              <label for="lifeExpectancyInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Life Expectancy (Age)</label>
              <input id="lifeExpectancyInput" type="number" value="90" min="65" max="100" placeholder="e.g., 90" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              <input id="lifeExpectancySlider" type="range" min="65" max="100" value="90" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>65</span>
                <span>100</span>
              </div>
            </div>
            <div class="pt-2">
                <p><span class="summary-label">Retirement Years Left:</span> <span id="retirementYearsLeft" class="summary-value">0 years</span></p>
            </div>
        </div>

        <!-- 2nd Section: Income -->
        <div class="space-y-4 border-b border-gray-200 dark:border-gray-700 pb-6">
            <h3 class="text-md font-semibold text-gray-500 dark:text-gray-400">Your Income (Today's Value)</h3>
            <div>
              <label for="monthlyIncomeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Monthly Income (Net)</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400 text-sm">₹</span>
                <input id="monthlyIncomeInput" type="number" value="100000" min="0" placeholder="e.g., 100000" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              </div>
              <span id="monthlyIncomeWords" class="text-xs italic text-gray-500 dark:text-gray-400 mt-1 block text-right"></span>
              <input id="monthlyIncomeSlider" type="range" min="0" max="2000000" value="100000" step="1000" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>₹0</span>
                <span>₹20,00,000</span>
              </div>
            </div>
            <div>
              <label for="yearlyIncomeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Annual Income (Net, e.g., Bonus)</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400 text-sm">₹</span>
                <input id="yearlyIncomeInput" type="number" value="1200000" min="0" placeholder="e.g., 1200000" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              </div>
              <span id="yearlyIncomeWords" class="text-xs italic text-gray-500 dark:text-gray-400 mt-1 block text-right"></span>
              <input id="yearlyIncomeSlider" type="range" min="0" max="20000000" value="1200000" step="10000" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>₹0</span>
                <span>₹2,00,00,000</span>
              </div>
            </div>
            <div class="pt-2">
                <p><span class="summary-label">Total Annual Income:</span> <span id="totalAnnualIncomeDisplay" class="summary-value">₹0</span></p>
            </div>
        </div>

        <!-- 3rd Section: Expenses -->
        <div class="space-y-4 border-b border-gray-200 dark:border-gray-700 pb-6">
            <h3 class="text-md font-semibold text-gray-500 dark:text-gray-400">Monthly Expenses (Today's Value)</h3>
            <div id="additionalExpensesContainer" class="space-y-3">
                <!-- Dynamic expense inputs will be added here -->
            </div>
            <button id="addExpenseBtn" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600 transition-colors duration-200 text-sm font-medium">Add Another Expense</button>
            <div class="pt-2 space-y-1">
                <p><span class="summary-label">Total Monthly Expenses:</span> <span id="totalCurrentMonthlyExpensesDisplay" class="summary-value">₹0</span></p>
                <p><span class="summary-label">Total Annual Expenses:</span> <span id="totalCurrentAnnualExpensesDisplay" class="summary-value">₹0</span></p>
                <p><span class="summary-label">Monthly Excess/Deficit:</span> <span id="monthlyExcessDisplay" class="summary-value">₹0</span></p>
                <p><span class="summary-label">Annual Excess/Deficit:</span> <span id="yearlyExcessDisplay" class="summary-value">₹0</span></p>
            </div>
        </div>

        <!-- 4th Section: Financial Planning Inputs -->
        <div class="space-y-4 pt-2">
            <h3 class="text-md font-semibold text-gray-500 dark:text-gray-400">Financial Planning</h3>
            <div>
              <label for="currentSavingsInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Savings & Investments</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400 text-sm">₹</span>
                <input id="currentSavingsInput" type="number" value="1000000" min="0" placeholder="e.g., 1000000" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              </div>
              <span id="currentSavingsWords" class="text-xs italic text-gray-500 dark:text-gray-400 mt-1 block text-right"></span>
              <input id="currentSavingsSlider" type="range" min="0" max="100000000" value="1000000" step="10000" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>₹0</span>
                <span>₹10,00,00,000</span>
              </div>
            </div>
            <div>
              <label for="postRetirementMonthlyAmountInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Desired Monthly Income in Retirement (Today's Value)</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400 text-sm">₹</span>
                <input id="postRetirementMonthlyAmountInput" type="number" value="40000" min="0" placeholder="e.g., 40000" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white">
              </div>
              <span id="postRetirementMonthlyAmountWords" class="text-xs italic text-gray-500 dark:text-gray-400 mt-1 block text-right"></span>
              <input id="postRetirementMonthlyAmountSlider" type="range" min="0" max="200000" value="40000" step="1000" class="w-full mt-2">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>₹0</span>
                <span>₹2,00,000</span>
              </div>
            </div>
            <div class="pt-2">
                <p><span class="summary-label">Desired Monthly Income at Retirement Age (Inflated Value):</span> <span id="inflatedRetirementMonthlyIncome" class="summary-value">₹0</span></p>
            </div>
        </div>
      </section>

      <!-- Right Side: Results Table -->
      <section class="w-full lg:w-2/3 space-y-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Your Financial Plan</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Age</th>
                  <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Starting Savings</th>
                  <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Net Cash Flow/Withdrawal</th>
                  <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ending Savings</th>
                  <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody id="financialPlanTableBody" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                <!-- Plan details will be populated here by JavaScript -->
                <tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">Enter your details to see the plan.</td></tr>
              </tbody>
            </table>
          </div>
          <div id="planSummary" class="mt-6 text-gray-700 dark:text-gray-300 space-y-2">
              <p><span class="summary-label">Financial Independence Achieved:</span> <span id="fiAge" class="summary-value">N/A</span></p>
              <p><span class="summary-label">Funds Last Until Age:</span> <span id="fundsLastAge" class="summary-value">N/A</span></p>
              <p><span class="summary-label">Remarks:</span> <span id="planRemarks" class="summary-value"></span></p>
          </div>
        </div>

        <!-- Assumptions Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mt-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Assumptions</h3>
            <p><span class="summary-label">Expected Inflation Rate:</span> <span id="displayInflationRate" class="summary-value"></span></p>
            <p><span class="summary-label">Pre-Retirement Return Rate:</span> <span id="displayPreRetirementRate" class="summary-value"></span></p>
            <p><span class="summary-label">Post-Retirement Return Rate:</span> <span id="displayPostRetirementRate" class="summary-value"></span></p>
        </div>
      </section>
    </div>
  </main>

  <!-- Placeholder for the Footer -->
  <div id="include-footer"></div>

  <script>
    // --- Constants ---
    const INFLATION_RATE = 0.07; // 7%
    const PRE_RETIREMENT_RETURN = 0.12; // 12%
    const POST_RETIREMENT_RETURN = 0.08; // 8%

    // --- DOM Elements ---
    const currentAgeInput = document.getElementById('currentAgeInput');
    const currentAgeSlider = document.getElementById('currentAgeSlider');
    const retirementAgeInput = document.getElementById('retirementAgeInput');
    const retirementAgeSlider = document.getElementById('retirementAgeSlider');
    const lifeExpectancyInput = document.getElementById('lifeExpectancyInput');
    const lifeExpectancySlider = document.getElementById('lifeExpectancySlider');
    const monthlyIncomeInput = document.getElementById('monthlyIncomeInput');
    const monthlyIncomeSlider = document.getElementById('monthlyIncomeSlider');
    const yearlyIncomeInput = document.getElementById('yearlyIncomeInput');
    const yearlyIncomeSlider = document.getElementById('yearlyIncomeSlider');
    const additionalExpensesContainer = document.getElementById('additionalExpensesContainer');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const currentSavingsInput = document.getElementById('currentSavingsInput');
    const currentSavingsSlider = document.getElementById('currentSavingsSlider');
    const postRetirementMonthlyAmountInput = document.getElementById('postRetirementMonthlyAmountInput');
    const postRetirementMonthlyAmountSlider = document.getElementById('postRetirementMonthlyAmountSlider');
    const financialPlanTableBody = document.getElementById('financialPlanTableBody');
    const fiAgeEl = document.getElementById('fiAge');
    const fundsLastAgeEl = document.getElementById('fundsLastAge');
    const planRemarksEl = document.getElementById('planRemarks');
    
    // New/Moved DOM elements for summary info
    const retirementYearsLeftDisplay = document.getElementById('retirementYearsLeft');
    const totalAnnualIncomeDisplay = document.getElementById('totalAnnualIncomeDisplay');
    const totalCurrentMonthlyExpensesDisplay = document.getElementById('totalCurrentMonthlyExpensesDisplay');
    const totalCurrentAnnualExpensesDisplay = document.getElementById('totalCurrentAnnualExpensesDisplay');
    const monthlyExcessDisplay = document.getElementById('monthlyExcessDisplay');
    const yearlyExcessDisplay = document.getElementById('yearlyExcessDisplay');
    const inflatedRetirementMonthlyIncome = document.getElementById('inflatedRetirementMonthlyIncome');

    const displayInflationRate = document.getElementById('displayInflationRate');
    const displayPreRetirementRate = document.getElementById('displayPreRetirementRate');
    const displayPostRetirementRate = document.getElementById('displayPostRetirementRate');

    // DOM elements for amount words
    const monthlyIncomeWords = document.getElementById('monthlyIncomeWords');
    const yearlyIncomeWords = document.getElementById('yearlyIncomeWords');
    const currentSavingsWords = document.getElementById('currentSavingsWords');
    const postRetirementMonthlyAmountWords = document.getElementById('postRetirementMonthlyAmountWords');


    // --- Utility Functions ---
    /**
     * Formats a number to Indian Rupee currency string.
     * @param {number} num - The number to format.
     * @returns {string} Formatted currency string.
     */
    function formatINR(num) {
      if (isNaN(num)) return '₹0';
      const absNum = Math.abs(num);
      let formatted;
      if (absNum >= 10000000) { // Crores
        formatted = (absNum / 10000000).toFixed(2) + ' Cr';
      } else if (absNum >= 100000) { // Lakhs
        formatted = (absNum / 100000).toFixed(2) + ' L';
      } else {
        formatted = absNum.toLocaleString('en-IN', { maximumFractionDigits: 0 });
      }
      return (num < 0 ? '-₹' : '₹') + formatted;
    }

    /**
     * Converts a number to words in Indian numbering system.
     * @param {number} num - The number to convert.
     * @returns {string} The number in words.
     */
    function numberToWords(num) {
        if (num === 0) return 'Zero';
        if (num < 0) return 'Minus ' + numberToWords(Math.abs(num));

        const words = [];
        const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

        function convertChunk(n) {
            let chunkWords = [];
            if (n >= 100) {
                chunkWords.push(units[Math.floor(n / 100)]);
                chunkWords.push('Hundred');
                n %= 100;
            }
            if (n > 0) {
                if (n < 20) {
                    chunkWords.push(units[n]);
                } else {
                    chunkWords.push(tens[Math.floor(n / 10)]);
                    if (n % 10 > 0) {
                        chunkWords.push(units[n % 10]);
                    }
                }
            }
            return chunkWords.join(' ');
        }

        let crore = Math.floor(num / 10000000);
        num %= 10000000;
        let lakh = Math.floor(num / 100000);
        num %= 100000;
        let thousand = Math.floor(num / 1000);
        num %= 1000;

        if (crore > 0) {
            words.push(convertChunk(crore));
            words.push('Crore');
        }
        if (lakh > 0) {
            words.push(convertChunk(lakh));
            words.push('Lakh');
        }
        if (thousand > 0) {
            words.push(convertChunk(thousand));
            words.push('Thousand');
        }
        if (num > 0) {
            words.push(convertChunk(num));
        }

        return words.join(' ');
    }


    /**
     * Calculates the future value of an amount considering inflation.
     * @param {number} amount - The initial amount.
     * @param {number} inflationRate - The annual inflation rate (e.g., 0.07 for 7%).
     * @param {number} years - The number of years.
     * @returns {number} The inflated amount.
     */
    function inflateAmount(amount, inflationRate, years) {
      if (years < 0) return amount; // No inflation for negative years
      return amount * Math.pow(1 + inflationRate, years);
    }

    /**
     * Calculates the compounded value of an amount.
     * @param {number} principal - The initial principal.
     * @param {number} annualRate - The annual return rate (e.g., 0.12 for 12%).
     * @returns {number} The compounded amount after one year.
     */
    function compoundAmount(principal, annualRate) {
        return principal * (1 + annualRate);
    }

    // --- Dynamic Expense Management ---
    let expenseCounter = 0; // To give unique IDs to expense items

    /**
     * Adds a new dynamic expense input row to the UI.
     */
    function addExpenseItem() {
        expenseCounter++;
        const expenseDiv = document.createElement('div');
        expenseDiv.className = 'expense-item'; // Tailwind classes for flex/grid and responsiveness
        expenseDiv.setAttribute('data-id', expenseCounter);
        expenseDiv.innerHTML = `
            <div class="expense-main-row">
                <input type="text" placeholder="e.g., Rent, Utilities" class="expense-description px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white" />
                <div class="flex items-center">
                    <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400 text-sm">₹</span>
                    <input type="number" value="0" min="0" placeholder="e.g., 15000" class="expense-amount flex-1 min-w-0 px-3 py-2 rounded-none rounded-r-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white" />
                </div>
                <button class="remove-expense-btn p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <span class="expense-amount-words text-xs italic text-gray-500 dark:text-gray-400 w-full text-right"></span>
        `;
        additionalExpensesContainer.appendChild(expenseDiv);

        const expenseAmountInput = expenseDiv.querySelector('.expense-amount');
        const expenseAmountWordsSpan = expenseDiv.querySelector('.expense-amount-words');

        expenseAmountWordsSpan.textContent = numberToWords(parseFloat(expenseAmountInput.value) || 0) + ' Rupees';

        expenseDiv.querySelector('.expense-description').addEventListener('input', calculateFinancialPlan);
        expenseAmountInput.addEventListener('input', () => {
            expenseAmountWordsSpan.textContent = numberToWords(parseFloat(expenseAmountInput.value) || 0) + ' Rupees';
            calculateFinancialPlan();
        });
        expenseDiv.querySelector('.remove-expense-btn').addEventListener('click', () => {
            expenseDiv.remove();
            calculateFinancialPlan();
        });
    }

    function getTotalDynamicExpenses() {
        let total = 0;
        document.querySelectorAll('.expense-item .expense-amount').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        return total;
    }

    // --- Core Calculation Logic ---
    function calculateFinancialPlan() {
      const currentAge = parseInt(currentAgeInput.value);
      const retirementAge = parseInt(retirementAgeInput.value);
      const lifeExpectancy = parseInt(lifeExpectancyInput.value);
      const monthlyIncome = parseFloat(monthlyIncomeInput.value) || 0;
      const yearlyIncome = parseFloat(yearlyIncomeInput.value) || 0;
      const currentSavings = parseFloat(currentSavingsInput.value) || 0;
      const postRetirementMonthlyAmount = parseFloat(postRetirementMonthlyAmountInput.value) || 0;

      const totalCurrentMonthlyExpenses = getTotalDynamicExpenses();
      const totalCurrentAnnualExpenses = totalCurrentMonthlyExpenses * 12;
      const totalAnnualIncome = (monthlyIncome * 12) + yearlyIncome;
      const desiredPostRetirementAnnualAmount = postRetirementMonthlyAmount * 12;

      const monthlyExcess = (totalAnnualIncome / 12) - totalCurrentMonthlyExpenses;
      const yearlyExcess = totalAnnualIncome - totalCurrentAnnualExpenses;


      let financialPlan = [];
      let currentSavingsBalance = currentSavings;
      let fundsDepletedAge = null;
      let fiAchievedAge = null;

      financialPlanTableBody.innerHTML = '';

      if (currentAge >= retirementAge) {
          planRemarksEl.textContent = "You are already at or past retirement age. The plan will start from your current age as retired.";
      } else if (currentAge >= lifeExpectancy) {
          planRemarksEl.textContent = "Your current age is at or past your life expectancy. Please adjust your age inputs.";
          financialPlanTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500 dark:text-red-400">Invalid age inputs. Please adjust.</td></tr>`;
          fiAgeEl.textContent = 'N/A';
          fundsLastAgeEl.textContent = 'N/A';
          return;
      }
      
      if (retirementAge > lifeExpectancy) {
          planRemarksEl.textContent = "Your retirement age is beyond your life expectancy. Please adjust your retirement age or life expectancy.";
          financialPlanTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500 dark:text-red-400">Invalid age inputs. Please adjust.</td></tr>`;
          fiAgeEl.textContent = 'N/A';
          fundsLastAgeEl.textContent = 'N/A';
          return;
      }

      const yearsToRetirement = retirementAge - currentAge;
      const inflatedDesiredMonthlyIncomeAtRetirement = inflateAmount(postRetirementMonthlyAmount, INFLATION_RATE, yearsToRetirement);


      for (let age = currentAge; age <= lifeExpectancy; age++) {
        let startingSavings = currentSavingsBalance;
        let annualNetCashFlow = 0;
        let status = '';
        let effectiveReturnRate = 0;
        
        let inflatedAnnualExpenses = inflateAmount(totalCurrentMonthlyExpenses * 12, INFLATION_RATE, age - currentAge);
        let inflatedPostRetirementAnnualWithdrawal = inflateAmount(desiredPostRetirementAnnualAmount, INFLATION_RATE, age - currentAge);
        let inflatedAnnualIncome = inflateAmount(totalAnnualIncome, INFLATION_RATE, age - currentAge);

        if (age < retirementAge) {
          status = 'Earning';
          effectiveReturnRate = PRE_RETIREMENT_RETURN;
          annualNetCashFlow = inflatedAnnualIncome - inflatedAnnualExpenses;
          
          currentSavingsBalance = compoundAmount(startingSavings + annualNetCashFlow, effectiveReturnRate);

          if (fiAchievedAge === null && currentSavingsBalance >= inflatedAnnualExpenses * 25) {
              fiAchievedAge = age;
          }

        } else {
          status = 'Retired';
          effectiveReturnRate = POST_RETIREMENT_RETURN;
          annualNetCashFlow = -inflatedPostRetirementAnnualWithdrawal;
          
          currentSavingsBalance = compoundAmount(startingSavings, effectiveReturnRate) + annualNetCashFlow;

          if (fundsDepletedAge === null && currentSavingsBalance < 0) {
              fundsDepletedAge = age;
          }
        }

        financialPlan.push({
          age: age,
          startingSavings: startingSavings,
          annualNetCashFlow: annualNetCashFlow,
          endingSavings: currentSavingsBalance,
          status: status
        });
      }

      if (financialPlan.length === 0) {
          financialPlanTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">No plan generated. Check inputs.</td></tr>`;
      } else {
          financialPlan.forEach(yearData => {
              const row = financialPlanTableBody.insertRow();
              row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150';
              row.innerHTML = `
                  <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${yearData.age}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${formatINR(yearData.startingSavings)}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-sm ${yearData.annualNetCashFlow >= 0 ? 'text-emerald-600' : 'text-red-600'} dark:${yearData.annualNetCashFlow >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatINR(yearData.annualNetCashFlow)}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-sm ${yearData.endingSavings >= 0 ? 'text-gray-700 dark:text-gray-300' : 'text-red-600 dark:text-red-400'}">${formatINR(yearData.endingSavings)}</td>
                  <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${yearData.status}</td>
              `;
          });
      }

      retirementYearsLeftDisplay.textContent = `${Math.max(0, retirementAge - currentAge)} years`;
      totalAnnualIncomeDisplay.textContent = formatINR(totalAnnualIncome);
      totalCurrentMonthlyExpensesDisplay.textContent = formatINR(totalCurrentMonthlyExpenses);
      totalCurrentAnnualExpensesDisplay.textContent = formatINR(totalCurrentAnnualExpenses);
      
      monthlyExcessDisplay.textContent = formatINR(monthlyExcess);
      monthlyExcessDisplay.classList.toggle('positive', monthlyExcess >= 0);
      monthlyExcessDisplay.classList.toggle('negative', monthlyExcess < 0);

      yearlyExcessDisplay.textContent = formatINR(yearlyExcess);
      yearlyExcessDisplay.classList.toggle('positive', yearlyExcess >= 0);
      yearlyExcessDisplay.classList.toggle('negative', yearlyExcess < 0);

      inflatedRetirementMonthlyIncome.textContent = formatINR(inflatedDesiredMonthlyIncomeAtRetirement);


      fiAgeEl.textContent = fiAchievedAge !== null ? fiAchievedAge : 'Not Achieved';
      fundsLastAgeEl.textContent = fundsDepletedAge !== null ? fundsDepletedAge : 'Beyond ' + lifeExpectancy;

      if (fundsDepletedAge !== null && fundsDepletedAge <= lifeExpectancy) {
          planRemarksEl.className = 'summary-value negative';
          planRemarksEl.textContent = `Warning: Your funds are projected to deplete by age ${fundsDepletedAge}. Consider increasing savings or adjusting expenses/retirement age.`;
      } else if (fiAchievedAge !== null && fiAchievedAge < retirementAge) {
          planRemarksEl.className = 'summary-value positive';
          planRemarksEl.textContent = `Excellent! You are projected to achieve financial independence by age ${fiAchievedAge}, well before your target retirement.`;
      } else {
          planRemarksEl.className = 'summary-value';
          planRemarksEl.textContent = `Your plan looks solid. Continue saving to maintain financial health throughout retirement.`;
      }
    }

    // --- Event Listeners and Initializer ---
    function syncInputs(inputEl, sliderEl, wordsEl, unit = '') {
        const updateWords = () => {
            if (wordsEl) {
                wordsEl.textContent = numberToWords(parseFloat(inputEl.value) || 0) + (unit ? ' ' + unit : '');
            }
        };

        const updateCalculator = () => {
            calculateFinancialPlan();
        };

        sliderEl.addEventListener('input', () => {
            inputEl.value = sliderEl.value;
            updateWords();
            updateCalculator();
        });
        inputEl.addEventListener('input', () => {
            sliderEl.value = inputEl.value;
            updateWords();
            updateCalculator();
        });
        updateWords();
    }

    async function loadPartial(id, file) {
      try {
        const response = await fetch(file);
        if (!response.ok) {
          throw new Error(`Failed to load ${file}: ${response.statusText}`);
        }
        const text = await response.text();
        const element = document.getElementById(id);
        if (element) {
          element.innerHTML = text;
          Array.from(element.querySelectorAll("script")).forEach(oldScript => {
            const newScript = document.createElement("script");
            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
            oldScript.parentNode.replaceChild(newScript, oldScript);
          });
        }
      } catch (error) {
        console.error(`Error loading partial: ${error}`);
      }
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([
        loadPartial("include-nav", "/components/nav.html"),
        loadPartial("include-footer", "/components/footer.html")
      ]);

      syncInputs(currentAgeInput, currentAgeSlider, null);
      syncInputs(retirementAgeInput, retirementAgeSlider, null);
      syncInputs(lifeExpectancyInput, lifeExpectancySlider, null);
      syncInputs(monthlyIncomeInput, monthlyIncomeSlider, monthlyIncomeWords, 'Rupees');
      syncInputs(yearlyIncomeInput, yearlyIncomeSlider, yearlyIncomeWords, 'Rupees');
      syncInputs(currentSavingsInput, currentSavingsSlider, currentSavingsWords, 'Rupees');
      syncInputs(postRetirementMonthlyAmountInput, postRetirementMonthlyAmountSlider, postRetirementMonthlyAmountWords, 'Rupees');

      addExpenseBtn.addEventListener('click', addExpenseItem);

      // Add a few default expense items for better user experience
      addExpenseItem();
      addExpenseItem();
      
      calculateFinancialPlan();

      displayInflationRate.textContent = `${(INFLATION_RATE * 100).toFixed(0)}%`;
      displayPreRetirementRate.textContent = `${(PRE_RETIREMENT_RETURN * 100).toFixed(0)}%`;
      displayPostRetirementRate.textContent = `${(POST_RETIREMENT_RETURN * 100).toFixed(0)}%`;
    });
  </script>
</body>
</html>
